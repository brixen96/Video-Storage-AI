# ðŸŽ¬ Video Page Specification

## Overview

The **Video Page** is the central hub for browsing, discovering, and managing all video files across the configured libraries (Movies, Edited, Backup/Raw, etc.). It combines a fast visual UX (grid/list), powerful filtering & sorting, per-video detail management, and deep integration with Performers, Studios, Groups, Tags and the AI Assistant.

Default view: **All libraries** (user can switch to a specific library via dropdown/tabs).

---

## Goals

-   Provide a fast, scannable grid of videos with looping previews and metadata at a glance.
-   Enable powerful filtering, sorting, and search to find media quickly.
-   Expose full video CRUD and metadata operations (fetch, edit, tag, delete) from the UI.
-   Integrate with existing Performer/Studio/Group systems and with AdultDataLink when applicable.
-   Be performant at scale (cached thumbnails, lazy loading, background scanning).
-   Surface AI suggestions (auto-tagging, metadata fixes) where helpful.

---

## UX / UI Components

### 1) Page Layout

-   **Top Bar:** Global search, library selector (All / Movies / Edited / Backup / custom libraries), view toggle (Grid / List), quick filters summary, bulk actions button, Activity Monitor toggle.
-   **Left Sidebar (collapsible):** Filter panel with advanced filters (Studio, Performer, Tags, Duration, Resolution, Date, AI tags, HasPreview, MissingMetadata, Library). Persisted state.
-   **Main Area:** Grid or List view of Video Cards. Infinite scroll or paginated pages.
-   **Right Drawer:** Video Details Panel (opens when clicking a card).

### 2) Video Cards (Grid View)

-   **Thumbnail / Preview:** Looping short `.mkv` preview if available, otherwise static thumbnail generated by FFmpeg. Lazy-loaded.
-   **Title:** Derived from metadata or filename (editable inline from details panel).
-   **Badges:** Duration, resolution, file size, favorite/pinned, rating.
-   **Performers:** Small circular thumbnails or initials; clickable to open Performer Details.
-   **Studio:** Small logo or name label (clickable).
-   **Hover UI:** Play overlay, quick actions (Add Tag, Edit Metadata, Open in Explorer), slight scale up and shadow.
-   **Selection:** Checkbox for bulk actions (top-left). Multi-select via Shift/Ctrl.
-   **Context Menu (right-click):** Fetch Metadata, Edit Metadata, Add/Remove Tags, Open in Explorer, Delete Video, Show in Filesystem.

### 3) Video List View (Alternative)

-   Row-based layout with sortable columns: Title, Library, Duration, Performers, Studio, Tags, Date Added, Size.
-   Inline multi-column filtering and column hide/show.

### 4) Video Details Panel (Right Drawer)

-   **Header:** Title, rating, favorite, pin, actions (Edit, Fetch Metadata, Delete, Open filepath).
-   **Player:** Large preview player (play/pause, scrub, volume, loop, frame seek). Support hardware decoding if available.
-   **Metadata Grid:** Filename, full path, library, codec, container, resolution, duration, bitrate, date created/modified, file size.
-   **Relations:** Linked Performers (clickable), Studio & Group (clickable), Linked Scenes (future), Related Videos (AI suggested).
-   **Tags:** Editable tag chips with autocomplete + `Add tag` input. Bulk apply to selected items supported.
-   **AI Suggestions:** Collapsible panel listing suggested tags, title corrections, or performer matches with confidence scores and accept/reject buttons.
-   **Activity / History:** Change history (metadata edits, fetch events) and last scan timestamp.

### 5) Bulk Actions

-   Apply tags, remove tags, move to library or folder, fetch metadata for selection, delete, export list or create playlist/collection.
-   Confirmation dialogs for destructive actions.

### 6) Quick Edit Mode

-   Small inline editor that allows quick title/tag edits directly from card hover or list row.

### 7) Filters & Search

-   **Global search bar:** fuzzy search across title, performers, studio, tags.
-   **Filter panel:** multi-select filters with counts. Supports range sliders (duration, file size, date range) and toggle filters (HasPreview, MissingMetadata, Zoo only).
-   **Saved filters / Views:** Users can save commonly used filter sets as named views.

### 8) Accessibility & Keyboard

-   Keyboard navigation for cards and lists (arrow keys), Enter to open details, Esc to close drawer.
-   Shortcuts: `F` favorite, `T` tag, `M` metadata edit, `Del` delete (with confirmation), `/` focus search.
-   ARIA labels for interactive components and semantic HTML for screen readers.

---

## Backend API Endpoints (Go)

| Operation       | Method | Endpoint                     | Description                                                                               |
| --------------- | -----: | ---------------------------- | ----------------------------------------------------------------------------------------- |
| List videos     |    GET | `/api/videos`                | Returns paginated list of videos. Accepts query params for filters, sort, page, pageSize. |
| Get video       |    GET | `/api/videos/{id}`           | Returns full video metadata and relations.                                                |
| Update video    |    PUT | `/api/videos/{id}`           | Update metadata (title, tags, performers links, studio, custom fields).                   |
| Delete video    | DELETE | `/api/videos/{id}`           | Delete video entry from DB (optionally delete file from disk with confirm).               |
| Fetch metadata  |   POST | `/api/videos/{id}/fetch`     | Fetch/enrich metadata from configured sources (AdultDataLink or others).                  |
| Scan libraries  |   POST | `/api/videos/scan`           | Trigger scan for new/removed videos. Returns job id / progress.                           |
| Add tag(s)      |   POST | `/api/videos/{id}/tags`      | Add tags to video.                                                                        |
| Remove tag(s)   | DELETE | `/api/videos/{id}/tags`      | Remove tags.                                                                              |
| Bulk operations |   POST | `/api/videos/bulk`           | Accepts list of ids and operation (tag, move, delete, fetch).                             |
| Thumbnails      |    GET | `/api/videos/{id}/thumbnail` | Returns cached thumbnail or generates on request.                                         |

Notes:

-   Filters/pagination: use typical params: `?library=edited&tags=action,interview&performer=123&sort=added_desc&page=1&pageSize=60`.
-   The `scan` endpoint should queue a background job integrated with the Live App Activity Monitor.

---

## Data Model / Schema

### Video Document (MongoDB-style sample)

```json
{
	"_id": "uuid-or-objectid",
	"title": "My Cool Clip",
	"filename": "clip001.mkv",
	"filepath": "D:/Media/Edited/clip001.mkv",
	"library": "edited",
	"duration": 125.32,
	"resolution": "1920x1080",
	"container": "mkv",
	"codec": "h264",
	"bitrate": 3500000,
	"size": 523452345,
	"date_created": "2025-01-01T12:00:00Z",
	"date_modified": "2025-08-21T09:12:00Z",
	"previews": ["/api/assets/Aidra Fox/preview1.mkv"],
	"thumbnail_path": "/api/thumbnails/uuid.jpg",
	"performers": ["performerId1", "performerId2"],
	"studio": "studioId",
	"groups": ["groupId1"],
	"tags": ["action", "interview"],
	"rating": null,
	"views": 0,
	"metadata_source": "local",
	"metadata_fetched_at": null,
	"missing_metadata": false,
	"has_preview": true,
	"created_at": "2025-10-31T12:00:00Z",
	"updated_at": "2025-11-01T12:00:00Z"
}
```

### Notes on fields

-   `previews` prefer local asset `.mkv` previews where possible. Store relative paths to assets API.
-   `thumbnail_path` should point to a cached JPG/WEBP generated by FFmpeg for grid view performance.
-   `missing_metadata` calculated boolean: true if core fields like title, performers or thumbnail are missing.

---

## Workflows

### 1) Scanning workflow (on-demand or scheduled)

-   `POST /api/videos/scan` triggered.
-   Backend enumerates configured library paths, finds video files by extensions list (configurable), extracts technical metadata (ffprobe), generates thumbnails/previews if missing, and upserts video documents into DB.
-   For new performers discovered by folder structure or metadata, dispatch create-performer flow (integrates with Performer startup scan).
-   Report progress and results to Live App Activity Monitor.

### 2) Adding a new video (manual)

-   User drags file into app or drops into watched folder.
-   App queues a scan job for the containing folder or triggers immediate import.
-   Extract metadata, generate thumbnail, create video document, link performers/studios if possible.

### 3) Fetch metadata (manual)

-   User triggers `/api/videos/{id}/fetch`.
-   Backend attempts to match title or performers with AdultDataLink (or other sources).
-   Merge fetched metadata into document per merge-strategy: update only blank fields, append array entries, keep local overrides intact.

### 4) Bulk tag operation

-   User selects multiple videos, applies tags.
-   Frontend calls `/api/videos/bulk` with operation=addTags and list of tags. Backend updates documents in a single atomic/batched operation.

---

## Performance & Scaling

-   **Thumbnail caching:** store generated thumbnails on disk with a TTL and check modification time of source file to invalidate cache.
-   **Lazy previews:** only load looping `.mkv` preview for cards that are within viewport or on hover.
-   **Pagination / Virtualized list:** implement virtual scrolling for large result sets (e.g., Vue Virtual Scroller).
-   **Background jobs:** scanning and metadata fetch run in background worker pool; communicate progress via WebSocket to the Live App Activity Monitor.
-   **Indexing:** use DB indexes on commonly filtered fields (library, tags, performers, created_at).

---

## Integration Points

-   **Performer, Studio & Group pages:** clicking a performer on a video card opens the Performer Details; vice versa, open Video Details from Performer/Studio pages.
-   **Live App Activity Monitor:** scanning and fetch jobs are visible and controllable from the monitor.
-   **AI Assistant:** provide auto-tag suggestions and related-video recommendations.
-   **AdultDataLink API:** used for enrichment where applicable (scene-level fetching to be planned later).

---

## UI Implementation Notes (Vue 3)

-   Use Composition API + modular components: `VideoGrid`, `VideoCard`, `VideoList`, `FilterPanel`, `VideoDetailsDrawer`, `BulkToolbar`, `PreviewPlayer`.
-   Use Bootstrap 5.3 grid for responsive layout, but custom CSS for card aspect ratio and preview handling (16:9). Keep dark theme variables centralized.
-   Use Font Awesome for action icons and status indicators.
-   Use WebSockets for live updates (scan progress, job completion).

---

## Security & Safety

-   Ensure file operations (delete/move) require confirmation and optionally a two-step confirmation for permanent deletion.
-   Sanitize all metadata fetching results and external links before storing or rendering.
-   Respect user privacy: API keys (AdultDataLink) stored securely in `.env` and never exposed to the frontend.

---

## Testing & QA

-   Unit tests for backend endpoints and DB operations.
-   Integration tests for scan/import pipeline (use a small test library with fixture files).
-   UI tests for card interactions, drawer open/close, filters, and bulk actions.
-   Performance tests on large index (10k files) to validate pagination and virtual scrolling.

---

## Next Steps / Roadmap

1. Implement core endpoints and DB schema.
2. Build `VideoGrid`, `VideoCard` and `VideoDetailsDrawer` components.
3. Implement scan worker and thumbnail generator (FFmpeg + ffprobe).
4. Integrate WebSocket updates with Live App Activity Monitor.
5. Add AI suggestions & AdultDataLink enrichment.
6. Polish UI (dark theme, hover effects, accessibility).
